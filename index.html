<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Pesquisadores</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/imask"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --dark: #1b263b;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --error: #f72585;
      --warning: #f8961e;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .app-container {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .app-header {
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      color: white;
      padding: 25px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .app-header::after {
      content: "";
      position: absolute;
      bottom: -50px;
      right: -50px;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }
    
    .app-header::before {
      content: "";
      position: absolute;
      top: -30px;
      left: -30px;
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }
    
    .app-title {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
    }
    
    .app-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 300;
      position: relative;
      z-index: 1;
    }
    
    .app-body {
      padding: 30px;
    }
    
    .form-group {
      margin-bottom: 25px;
      position: relative;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.95rem;
      color: var(--dark);
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
      outline: none;
      background-color: white;
    }
    
    .loading-indicator {
      position: absolute;
      right: 15px;
      top: 40px;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(67, 97, 238, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .loading-indicator.active {
      opacity: 1;
    }
    
    .result-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid var(--primary);
      animation: fadeIn 0.4s ease-out;
    }
    
    .result-item {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    
    .result-icon {
      margin-right: 12px;
      font-size: 1.2rem;
      color: var(--primary);
    }
    
    .result-label {
      font-weight: 600;
      color: var(--dark);
      min-width: 120px;
    }
    
    .error-message {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 5px;
      display: none;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .suggestions {
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: none;
    }
    
    .suggestion-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .suggestion-item:hover {
      background-color: #f8f9fa;
    }
    
    .suggestion-cpf {
      font-size: 0.8rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <h1 class="app-title">Consulta de Pesquisadores</h1>
      <p class="app-subtitle">Digite o CPF para autocompletar os dados</p>
    </div>
    
    <div class="app-body">
      <div class="form-group">
        <label for="cpf" class="form-label">CPF do Pesquisador</label>
        <input type="text" id="cpf" class="form-control" placeholder="Digite o CPF (com ou sem formata√ß√£o)" maxlength="14" />
        <div class="loading-indicator" id="loadingIndicator"></div>
        <div class="suggestions" id="suggestions"></div>
        <div class="error-message" id="cpfError"></div>
      </div>
      
      <div class="form-group">
        <label for="nome" class="form-label">Nome Completo</label>
        <input type="text" id="nome" class="form-control" placeholder="Ser√° preenchido automaticamente" readonly />
      </div>
      
      <div class="form-group">
        <label for="departamento" class="form-label">Departamento</label>
        <input type="text" id="departamento" class="form-control" placeholder="Ser√° preenchido automaticamente" readonly />
      </div>
      
      <div class="result-container" id="resultContainer" style="display: none;">
        <div class="result-item">
          <span class="result-icon">üë§</span>
          <span class="result-label">Nome:</span>
          <span id="resultNome"></span>
        </div>
        <div class="result-item">
          <span class="result-icon">üè¢</span>
          <span class="result-label">Departamento:</span>
          <span id="resultDepto"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configura√ß√µes
    const config = {
      scriptId: "AKfycbwERRt7pvVa3jG5EH74TlirrTyic4sVMoU88oPLMrdI7NfV-1-Y9BE241N9Mm_BBFo",
      debounceTime: 500
    };
    
    // Elementos DOM
    const cpfInput = document.getElementById("cpf");
    const nomeInput = document.getElementById("nome");
    const deptoInput = document.getElementById("departamento");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const cpfError = document.getElementById("cpfError");
    const resultContainer = document.getElementById("resultContainer");
    const resultNome = document.getElementById("resultNome");
    const resultDepto = document.getElementById("resultDepto");
    const suggestions = document.getElementById("suggestions");
    
    // Vari√°veis
    let debounceTimer;
    let lastCpf = "";
    
    // Aplicar m√°scara de CPF
    const cpfMask = IMask(cpfInput, {
      mask: '000.000.000-00'
    });
    
    // Formatar CPF
    function formatarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length > 9) {
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }
      return cpf;
    }
    
    // Validar CPF
    function validarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;

      return true;
    }
    
    // Mostrar loading
    function showLoading(show) {
      if (show) {
        loadingIndicator.classList.add("active");
      } else {
        loadingIndicator.classList.remove("active");
      }
    }
    
    // Mostrar erro
    function showError(message) {
      cpfError.textContent = message;
      cpfError.style.display = "block";
      resultContainer.style.display = "none";
    }
    
    // Limpar erro
    function clearError() {
      cpfError.style.display = "none";
    }
    
    // Mostrar resultados
    function showResults(data) {
      nomeInput.value = data.nome || "";
      deptoInput.value = data.departamento || "";
      
      resultNome.textContent = data.nome || "N√£o informado";
      resultDepto.textContent = data.departamento || "N√£o informado";
      resultContainer.style.display = "block";
    }
    
    // Limpar resultados
    function clearResults() {
      nomeInput.value = "";
      deptoInput.value = "";
      resultContainer.style.display = "none";
    }
    
    // Buscar pesquisador
    async function buscarPesquisador(cpf) {
      if (cpf === lastCpf) return;
      lastCpf = cpf;
      
      if (!cpf || cpf.length !== 11) {
        clearResults();
        return;
      }
      
      if (!validarCPF(cpf)) {
        showError("CPF inv√°lido");
        clearResults();
        return;
      }
      
      clearError();
      showLoading(true);
      
      try {
        const response = await fetch(`https://script.google.com/macros/s/${config.scriptId}/exec?cpf=${cpf}`);
        
        if (!response.ok) {
          throw new Error("Erro na rede");
        }
        
        const data = await response.json();
        
        if (data.erro) {
          showError(data.erro);
          clearResults();
        } else {
          showResults(data);
        }
      } catch (error) {
        console.error("Erro na busca:", error);
        showError("Erro ao buscar dados. Tente novamente.");
        clearResults();
      } finally {
        showLoading(false);
      }
    }
    
    // Buscar sugest√µes (para o autocomplete)
    async function buscarSugestoes(cpf) {
      if (cpf.length < 3) {
        suggestions.style.display = "none";
        return;
      }
      
      try {
        const response = await fetch(`https://script.google.com/macros/s/${config.scriptId}/exec?busca=${cpf}`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          suggestions.innerHTML = "";
          data.forEach(item => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerHTML = `
              <div>${item.nome}</div>
              <div class="suggestion-cpf">${formatarCPF(item.cpf)}</div>
            `;
            div.addEventListener("click", () => {
              cpfMask.value = item.cpf;
              suggestions.style.display = "none";
              buscarPesquisador(item.cpf.replace(/\D/g, ''));
            });
            suggestions.appendChild(div);
          });
          suggestions.style.display = "block";
        } else {
          suggestions.style.display = "none";
        }
      } catch (error) {
        console.error("Erro ao buscar sugest√µes:", error);
        suggestions.style.display = "none";
      }
    }
    
    // Event listeners
    cpfInput.addEventListener("input", () => {
      const cpf = cpfMask.unmaskedValue;
      clearError();
      
      // Debounce para evitar muitas requisi√ß√µes
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        if (cpf.length === 11) {
          buscarPesquisador(cpf);
        } else if (cpf.length > 0) {
          buscarSugestoes(cpf);
        } else {
          clearResults();
          suggestions.style.display = "none";
        }
      }, config.debounceTime);
    });
    
    // Fechar sugest√µes ao clicar fora
    document.addEventListener("click", (e) => {
      if (e.target !== cpfInput) {
        suggestions.style.display = "none";
      }
    });
    
    // Atualizar o Apps Script para suportar busca por partes
    // Adicione esta fun√ß√£o ao seu Google Apps Script:
    /*
    function doGet(e) {
      const cpf = e.parameter.cpf ? e.parameter.cpf.replace(/\D/g, '') : '';
      const busca = e.parameter.busca ? e.parameter.busca.replace(/\D/g, '') : '';
      
      const SPREADSHEET_ID = "1J9yHiKY0BsJYCqKsPh7WESJ6d7MlDTorfYeJYx4ObFA";
      const SHEET_NAME = "Pesquisador";
      
      try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(SHEET_NAME);
        const dados = sheet.getDataRange().getValues();
        
        // Busca exata por CPF
        if (cpf) {
          for (let i = 1; i < dados.length; i++) {
            const cpfPlanilha = String(dados[i][0]).replace(/\D/g, '');
            if (cpfPlanilha === cpf) {
              return ContentService.createTextOutput(JSON.stringify({
                nome: dados[i][1],
                departamento: dados[i][2]
              })).setMimeType(ContentService.MimeType.JSON);
            }
          }
          return ContentService.createTextOutput(JSON.stringify({
            erro: "Pesquisador n√£o encontrado"
          })).setMimeType(ContentService.MimeType.JSON);
        }
        
        // Busca parcial para sugest√µes
        if (busca) {
          const resultados = [];
          for (let i = 1; i < dados.length && resultados.length < 5; i++) {
            const cpfPlanilha = String(dados[i][0]).replace(/\D/g, '');
            const nomePlanilha = String(dados[i][1]).toLowerCase();
            
            if (cpfPlanilha.includes(busca) || nomePlanilha.includes(busca.toLowerCase())) {
              resultados.push({
                cpf: cpfPlanilha,
                nome: dados[i][1]
              });
            }
          }
          return ContentService.createTextOutput(JSON.stringify(resultados))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        return ContentService.createTextOutput(JSON.stringify({
          erro: "Par√¢metros inv√°lidos"
        })).setMimeType(ContentService.MimeType.JSON);
        
      } catch (error) {
        return ContentService.createTextOutput(JSON.stringify({
          erro: "Erro no servidor: " + error.message
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    */
  </script>
</body>
</html>